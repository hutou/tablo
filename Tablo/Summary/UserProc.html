<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Crystal Docs 1.11.2">
<meta name="crystal_docs.project_version" content="development">
<meta name="crystal_docs.project_name" content="tablo">



<link href="../../css/style.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="../../js/doc.js"></script>

  <meta name="repository-name" content="tablo">
  <title>Tablo::Summary::UserProc(T) - tablo development</title>
  <script type="text/javascript">
    CrystalDocs.base_path = "../../";
  </script>
</head>
<body>

<svg class="hidden">
  <symbol id="octicon-link" viewBox="0 0 16 16">
    <path fill="currentColor" fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
  </symbol>
</svg>
<input type="checkbox" id="sidebar-btn">
<label for="sidebar-btn" id="sidebar-btn-label">
  <svg class="open" xmlns="http://www.w3.org/2000/svg" height="2em" width="2em" viewBox="0 0 512 512"><title>Open Sidebar</title><path fill="currentColor" d="M80 96v64h352V96H80zm0 112v64h352v-64H80zm0 112v64h352v-64H80z"></path></svg>
  <svg class="close" xmlns="http://www.w3.org/2000/svg" width="2em" height="2em" viewBox="0 0 512 512"><title>Close Sidebar</title><path fill="currentColor" d="m118.6 73.4-45.2 45.2L210.7 256 73.4 393.4l45.2 45.2L256 301.3l137.4 137.3 45.2-45.2L301.3 256l137.3-137.4-45.2-45.2L256 210.7Z"></path></svg>
</label>
<div class="sidebar">
  <div class="sidebar-header">
    <div class="search-box">
      <input type="search" class="search-input" placeholder="Search..." spellcheck="false" aria-label="Search">
    </div>

    <div class="project-summary">
      <h1 class="project-name">
        <a href="../../index.html">
          tablo
        </a>
      </h1>

      <span class="project-version">
        development
      </span>
    </div>
  </div>

  <div class="search-results hidden">
    <ul class="search-list"></ul>
  </div>

  <div class="types-list">
    <ul>
  
  <li class="parent open current" data-id="tablo/Tablo" data-name="tablo">
      <a href="../../Tablo.html">Tablo</a>
      
        <ul>
  
  <li class="parent " data-id="tablo/Tablo/Border" data-name="tablo::border">
      <a href="../../Tablo/Border.html">Border</a>
      
        <ul>
  
  <li class=" " data-id="tablo/Tablo/Border/PreSet" data-name="tablo::border::preset">
      <a href="../../Tablo/Border/PreSet.html">PreSet</a>
      
    </li>
  
  <li class=" " data-id="tablo/Tablo/Border/Styler" data-name="tablo::border::styler">
      <a href="../../Tablo/Border/Styler.html">Styler</a>
      
    </li>
  
</ul>

      
    </li>
  
  <li class="parent " data-id="tablo/Tablo/Cell" data-name="tablo::cell">
      <a href="../../Tablo/Cell.html">Cell</a>
      
        <ul>
  
  <li class="parent " data-id="tablo/Tablo/Cell/Data" data-name="tablo::cell::data">
      <a href="../../Tablo/Cell/Data.html">Data</a>
      
        <ul>
  
  <li class=" " data-id="tablo/Tablo/Cell/Data/Coords" data-name="tablo::cell::data::coords">
      <a href="../../Tablo/Cell/Data/Coords.html">Coords</a>
      
    </li>
  
  <li class=" " data-id="tablo/Tablo/Cell/Data/Formatter" data-name="tablo::cell::data::formatter">
      <a href="../../Tablo/Cell/Data/Formatter.html">Formatter</a>
      
    </li>
  
  <li class=" " data-id="tablo/Tablo/Cell/Data/Styler" data-name="tablo::cell::data::styler">
      <a href="../../Tablo/Cell/Data/Styler.html">Styler</a>
      
    </li>
  
</ul>

      
    </li>
  
  <li class="parent " data-id="tablo/Tablo/Cell/Text" data-name="tablo::cell::text">
      <a href="../../Tablo/Cell/Text.html">Text</a>
      
        <ul>
  
  <li class=" " data-id="tablo/Tablo/Cell/Text/Formatter" data-name="tablo::cell::text::formatter">
      <a href="../../Tablo/Cell/Text/Formatter.html">Formatter</a>
      
    </li>
  
  <li class=" " data-id="tablo/Tablo/Cell/Text/Styler" data-name="tablo::cell::text::styler">
      <a href="../../Tablo/Cell/Text/Styler.html">Styler</a>
      
    </li>
  
</ul>

      
    </li>
  
</ul>

      
    </li>
  
  <li class=" " data-id="tablo/Tablo/CellType" data-name="tablo::celltype">
      <a href="../../Tablo/CellType.html">CellType</a>
      
    </li>
  
  <li class=" " data-id="tablo/Tablo/Column" data-name="tablo::column(t)">
      <a href="../../Tablo/Column.html">Column</a>
      
    </li>
  
  <li class="parent " data-id="tablo/Tablo/Config" data-name="tablo::config">
      <a href="../../Tablo/Config.html">Config</a>
      
        <ul>
  
  <li class=" " data-id="tablo/Tablo/Config/Controls" data-name="tablo::config::controls">
      <a href="../../Tablo/Config/Controls.html">Controls</a>
      
    </li>
  
  <li class=" " data-id="tablo/Tablo/Config/Defaults" data-name="tablo::config::defaults">
      <a href="../../Tablo/Config/Defaults.html">Defaults</a>
      
    </li>
  
</ul>

      
    </li>
  
  <li class="parent " data-id="tablo/Tablo/Error" data-name="tablo::error">
      <a href="../../Tablo/Error.html">Error</a>
      
        <ul>
  
  <li class=" " data-id="tablo/Tablo/Error/DuplicateLabel" data-name="tablo::error::duplicatelabel">
      <a href="../../Tablo/Error/DuplicateLabel.html">DuplicateLabel</a>
      
    </li>
  
  <li class=" " data-id="tablo/Tablo/Error/GroupEmpty" data-name="tablo::error::groupempty">
      <a href="../../Tablo/Error/GroupEmpty.html">GroupEmpty</a>
      
    </li>
  
  <li class=" " data-id="tablo/Tablo/Error/InvalidBorderDefinition" data-name="tablo::error::invalidborderdefinition">
      <a href="../../Tablo/Error/InvalidBorderDefinition.html">InvalidBorderDefinition</a>
      
    </li>
  
  <li class=" " data-id="tablo/Tablo/Error/InvalidColumnIndex" data-name="tablo::error::invalidcolumnindex">
      <a href="../../Tablo/Error/InvalidColumnIndex.html">InvalidColumnIndex</a>
      
    </li>
  
  <li class=" " data-id="tablo/Tablo/Error/InvalidValue" data-name="tablo::error::invalidvalue">
      <a href="../../Tablo/Error/InvalidValue.html">InvalidValue</a>
      
    </li>
  
  <li class=" " data-id="tablo/Tablo/Error/LabelNotFound" data-name="tablo::error::labelnotfound">
      <a href="../../Tablo/Error/LabelNotFound.html">LabelNotFound</a>
      
    </li>
  
</ul>

      
    </li>
  
  <li class="parent " data-id="tablo/Tablo/Functions" data-name="tablo::functions">
      <a href="../../Tablo/Functions.html">Functions</a>
      
        <ul>
  
  <li class=" " data-id="tablo/Tablo/Functions/FPAlign" data-name="tablo::functions::fpalign">
      <a href="../../Tablo/Functions/FPAlign.html">FPAlign</a>
      
    </li>
  
</ul>

      
    </li>
  
  <li class=" " data-id="tablo/Tablo/Heading" data-name="tablo::heading">
      <a href="../../Tablo/Heading.html">Heading</a>
      
    </li>
  
  <li class=" " data-id="tablo/Tablo/Justify" data-name="tablo::justify">
      <a href="../../Tablo/Justify.html">Justify</a>
      
    </li>
  
  <li class=" " data-id="tablo/Tablo/LabelType" data-name="tablo::labeltype">
      <a href="../../Tablo/LabelType.html">LabelType</a>
      
    </li>
  
  <li class="parent open current" data-id="tablo/Tablo/Summary" data-name="tablo::summary(t, u, v)">
      <a href="../../Tablo/Summary.html">Summary</a>
      
        <ul>
  
  <li class=" " data-id="tablo/Tablo/Summary/BodyColumn" data-name="tablo::summary::bodycolumn">
      <a href="../../Tablo/Summary/BodyColumn.html">BodyColumn</a>
      
    </li>
  
  <li class=" " data-id="tablo/Tablo/Summary/BodyRow" data-name="tablo::summary::bodyrow">
      <a href="../../Tablo/Summary/BodyRow.html">BodyRow</a>
      
    </li>
  
  <li class=" " data-id="tablo/Tablo/Summary/HeaderColumn" data-name="tablo::summary::headercolumn">
      <a href="../../Tablo/Summary/HeaderColumn.html">HeaderColumn</a>
      
    </li>
  
  <li class=" current" data-id="tablo/Tablo/Summary/UserProc" data-name="tablo::summary::userproc(t)">
      <a href="../../Tablo/Summary/UserProc.html">UserProc</a>
      
    </li>
  
</ul>

      
    </li>
  
  <li class=" " data-id="tablo/Tablo/Table" data-name="tablo::table(t)">
      <a href="../../Tablo/Table.html">Table</a>
      
    </li>
  
  <li class=" " data-id="tablo/Tablo/WrapMode" data-name="tablo::wrapmode">
      <a href="../../Tablo/WrapMode.html">WrapMode</a>
      
    </li>
  
</ul>

      
    </li>
  
</ul>

  </div>
</div>


<div class="main-content">
<h1 class="type-name">

  <span class="kind">struct</span> Tablo::<wbr>Summary::<wbr>UserProc(T)

</h1>


  <ul class="superclass-hierarchy"><li class="superclass"><a href="../../Tablo/Summary/UserProc.html">Tablo::Summary::UserProc(T)</a></li><li class="superclass">Struct</li><li class="superclass">Value</li><li class="superclass">Object</li></ul>




  <h2>
    <a id="overview" class="anchor" href="#overview">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>
    Overview
  </h2>

  <p>The <code><a href="../../Tablo/Summary/UserProc.html">Summary::UserProc</a></code> struct lets you define specific functions to be applied
to source data, accessible either by column or directly from the source,
in order to provide aggregated results.</p>














  <h2>
    <a id="defined-in" class="anchor" href="#defined-in">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>
    Defined in:
  </h2>
  
    
      <a href="https://github.com/hutou/tablo/blob/533912d931f0a2e4b9e7c79100c79ab302d3e90e/src/summary.cr#L398" target="_blank">
        summary.cr
      </a>
    
    <br/>
  





  <h2>
    <a id="constructors" class="anchor" href="#constructors">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>
    Constructors
  </h2>
  <ul class="list-summary">
    
      <li class="entry-summary">
        <a href="#new%28proc%3AProc%28Table%28T%29%2CHash%28Symbol%2CCellType%29%29%29-class-method" class="signature"><strong>.new</strong>(proc : Proc(Table(T), Hash(Symbol, CellType)))</a>
        
          <div class="summary"><p>The constructor's only parameter is a Proc, which in turn expects a Table(T) as its only parameter.</p></div>
        
      </li>
    
  </ul>









<div class="methods-inherited">
  
    


    


    


    


  
    


    


    


    


  
    


    


    


    


  
</div>


  <h2>
    <a id="constructor-detail" class="anchor" href="#constructor-detail">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>
    Constructor Detail
  </h2>
  
    <div class="entry-detail" id="new(proc:Proc(Table(T),Hash(Symbol,CellType)))-class-method">
      <div class="signature">
        
        def self.<strong>new</strong>(proc : Proc(<a href="../../Tablo/Table.html">Table</a>(T), Hash(Symbol, <a href="../../Tablo/CellType.html">CellType</a>)))

        <a class="method-permalink" href="#new%28proc%3AProc%28Table%28T%29%2CHash%28Symbol%2CCellType%29%29%29-class-method">#</a>
      </div>
      
        <div class="doc">
          
          <p>The constructor's only parameter is a Proc, which in turn expects
a Table(T) as its only parameter.</p>
<p>The <em>table</em> parameter allows the user to access detailed data in two ways:</p>
<ol>
<li>by directly accessing the data source: <code>table.sources.each ...</code></li>
<li>by accessing data via column definition: <code>table.column_data(column_label).each....</code></li>
</ol>
<p>Note that access via column definition allows the use of data not directly
present in the source, but has the disadvantage of indirect (and
slower) access to  data via the user-defined <em>extractor</em> in
the <code><a href="../../Tablo/Table.html#add_column%28label%3ALabelType%2C%2A%2Cheader%3Dlabel.to_s%2Cheader_alignment%3Dheader_alignment%2Cheader_formatter%3Dheader_formatter%2Cheader_styler%3Dheader_styler%2Cbody_alignment%3Dbody_alignment%2Cbody_formatter%3Dbody_formatter%2Cbody_styler%3Dbody_styler%2Cleft_padding%3Dleft_padding%2Cright_padding%3Dright_padding%2Cpadding_character%3Dpadding_character%2Cwidth%3Dwidth%2Ctruncation_indicator%3Dtruncation_indicator%2Cwrap_mode%3Dwrap_mode%2C%26extractor%3AT%2CInt32-%3ECellType%29-instance-method">Table#add_column</a></code> method.</p>
<p>The Proc must return a hash of results (of type <code><a href="../../Tablo/CellType.html">Tablo::CellType</a></code>), which, when
used inside a Summary table definition, are automatically saved for
future use (see the <code><a href="../../Tablo/Summary.html#use%28key%29-class-method">Summary.use</a></code> method in <code><a href="../../Tablo/Summary/BodyRow.html">Summary::BodyRow</a></code>).</p>
<p>Example of accessing data directly from source (note that, in this
reduced example, we don't even need to define any columns):</p>
<pre><code class="language-crystal"><span class="k">require</span> <span class="s">&quot;tablo&quot;</span>

<span class="k">struct</span> <span class="t">InvoiceItem</span>
  getter product, quantity, price

  <span class="k">def</span> <span class="m">initialize</span>(@product : <span class="t">String</span>, @quantity : <span class="t">Int32</span>?, @price : <span class="t">Int32</span>?)
  <span class="k">end</span>
<span class="k">end</span>

invoice <span class="o">=</span> [
  <span class="t">InvoiceItem</span>.new(<span class="s">&quot;Laptop&quot;</span>, <span class="n">3</span>, <span class="n">98000</span>),
  <span class="t">InvoiceItem</span>.new(<span class="s">&quot;Printer&quot;</span>, <span class="n">2</span>, <span class="n">15499</span>),
  <span class="t">InvoiceItem</span>.new(<span class="s">&quot;Router&quot;</span>, <span class="n">1</span>, <span class="n">9900</span>),
  <span class="t">InvoiceItem</span>.new(<span class="s">&quot;Switch&quot;</span>, <span class="n">nil</span>, <span class="n">4500</span>),
  <span class="t">InvoiceItem</span>.new(<span class="s">&quot;Accessories&quot;</span>, <span class="n">5</span>, <span class="n">6450</span>),
]

table <span class="o">=</span> <span class="t">Tablo</span><span class="t">::</span><span class="t">Table</span>.new(invoice)

userproc <span class="o">=</span> <span class="t">Tablo</span><span class="t">::</span><span class="t">Summary</span><span class="t">::</span><span class="t">UserProc</span>.new(
  proc: <span class="o">-&gt;</span>(tbl : <span class="t">Tablo</span><span class="t">::</span><span class="t">Table</span>(<span class="t">InvoiceItem</span>)) {
    total_sum <span class="o">=</span> total_count <span class="o">=</span> max_price <span class="o">=</span> <span class="n">0</span>
    tbl.sources.each <span class="k">do</span> <span class="o">|</span>row<span class="o">|</span>
      <span class="k">next</span> <span class="k">unless</span> row.quantity.<span class="k">is_a?</span>(<span class="t">Int32</span>) <span class="o">&amp;&amp;</span> row.price.<span class="k">is_a?</span>(<span class="t">Int32</span>)
      total_count <span class="o">+=</span> <span class="n">1</span>
      max_price <span class="o">=</span> [max_price, row.price.<span class="k">as</span>(<span class="t">Int32</span>)].max
      total_sum <span class="o">+=</span> row.quantity.<span class="k">as</span>(<span class="t">Int32</span>) <span class="o">*</span> row.price.<span class="k">as</span>(<span class="t">Int32</span>)
    <span class="k">end</span>
    {
      <span class="n">:total_count</span> <span class="o">=&gt;</span> total_count.<span class="k">as</span>(<span class="t">Tablo</span><span class="t">::</span><span class="t">CellType</span>),
      <span class="n">:total_sum</span>   <span class="o">=&gt;</span> total_sum.<span class="k">as</span>(<span class="t">Tablo</span><span class="t">::</span><span class="t">CellType</span>),
      <span class="n">:max_price</span>   <span class="o">=&gt;</span> max_price.<span class="k">as</span>(<span class="t">Tablo</span><span class="t">::</span><span class="t">CellType</span>),
    }
  })

hash <span class="o">=</span> userproc.proc.call(table)

puts hash[<span class="n">:total_sum</span>]   <span class="c"># =&gt; 367148</span>
puts hash[<span class="n">:total_count</span>] <span class="c"># =&gt; 4</span>
puts hash[<span class="n">:max_price</span>]   <span class="c"># =&gt; 98000</span></code></pre>
<p>Another example, this time using column access via <code><a href="../../Tablo/Table.html#column_data%28column_label%3ALabelType%29-instance-method">Table#column_data</a></code>, with iterators:</p>
<pre><code class="language-crystal"><span class="k">require</span> <span class="s">&quot;tablo&quot;</span>

<span class="k">struct</span> <span class="t">InvoiceItem</span>
  getter product, quantity, price

  <span class="k">def</span> <span class="m">initialize</span>(@product : <span class="t">String</span>, @quantity : <span class="t">Int32</span>?, @price : <span class="t">Int32</span>?)
  <span class="k">end</span>
<span class="k">end</span>

invoice <span class="o">=</span> [
  <span class="t">InvoiceItem</span>.new(<span class="s">&quot;Laptop&quot;</span>, <span class="n">3</span>, <span class="n">98000</span>),
  <span class="t">InvoiceItem</span>.new(<span class="s">&quot;Printer&quot;</span>, <span class="n">2</span>, <span class="n">15499</span>),
  <span class="t">InvoiceItem</span>.new(<span class="s">&quot;Router&quot;</span>, <span class="n">1</span>, <span class="n">9900</span>),
  <span class="t">InvoiceItem</span>.new(<span class="s">&quot;Switch&quot;</span>, <span class="n">nil</span>, <span class="n">4500</span>),
  <span class="t">InvoiceItem</span>.new(<span class="s">&quot;Accessories&quot;</span>, <span class="n">5</span>, <span class="n">6450</span>),
]

table <span class="o">=</span> <span class="t">Tablo</span><span class="t">::</span><span class="t">Table</span>.new(invoice) <span class="k">do</span> <span class="o">|</span>t<span class="o">|</span>
  t.add_column(<span class="s">&quot;Quantity&quot;</span>, <span class="o">&amp;</span>.quantity)
  t.add_column(<span class="s">&quot;Price&quot;</span>, <span class="o">&amp;</span>.price)
<span class="k">end</span>

userproc <span class="o">=</span> <span class="t">Tablo</span><span class="t">::</span><span class="t">Summary</span><span class="t">::</span><span class="t">UserProc</span>.new(
  proc: <span class="o">-&gt;</span>(tbl : <span class="t">Tablo</span><span class="t">::</span><span class="t">Table</span>(<span class="t">InvoiceItem</span>)) {
    total_sum <span class="o">=</span> total_count <span class="o">=</span> max_price <span class="o">=</span> <span class="n">0</span>
    iter_quantity <span class="o">=</span> tbl.column_data(<span class="s">&quot;Quantity&quot;</span>).each
    iter_price <span class="o">=</span> tbl.column_data(<span class="s">&quot;Price&quot;</span>).each
    iter <span class="o">=</span> iter_quantity.zip(iter_price)
    iter.each <span class="k">do</span> <span class="o">|</span>q, p<span class="o">|</span>
      <span class="k">next</span> <span class="k">unless</span> q.<span class="k">is_a?</span>(<span class="t">Int32</span>) <span class="o">&amp;&amp;</span> p.<span class="k">is_a?</span>(<span class="t">Int32</span>)
      total_sum <span class="o">+=</span> q <span class="o">*</span> p
      total_count <span class="o">+=</span> <span class="n">1</span>
      max_price <span class="o">=</span> [max_price, p].max
    <span class="k">end</span>
    {
      <span class="n">:total_count</span> <span class="o">=&gt;</span> total_count.<span class="k">as</span>(<span class="t">Tablo</span><span class="t">::</span><span class="t">CellType</span>),
      <span class="n">:total_sum</span>   <span class="o">=&gt;</span> total_sum.<span class="k">as</span>(<span class="t">Tablo</span><span class="t">::</span><span class="t">CellType</span>),
      <span class="n">:max_price</span>   <span class="o">=&gt;</span> max_price.<span class="k">as</span>(<span class="t">Tablo</span><span class="t">::</span><span class="t">CellType</span>),
    }
  })

hash <span class="o">=</span> userproc.proc.call(table)

puts hash[<span class="n">:total_sum</span>]   <span class="c"># =&gt; 367148</span>
puts hash[<span class="n">:total_count</span>] <span class="c"># =&gt; 4</span>
puts hash[<span class="n">:max_price</span>]   <span class="c"># =&gt; 98000</span></code></pre>
<p>Note that column access is about 3 times slower.</p>
        </div>
      
      <br/>
      <div>
        
          [<a href="https://github.com/hutou/tablo/blob/533912d931f0a2e4b9e7c79100c79ab302d3e90e/src/summary.cr#L511" target="_blank">View source</a>]
        
      </div>
    </div>
  








</div>

</body>
</html>
